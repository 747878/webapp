<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-[#fcf8f8] group/design-root overflow-x-hidden"
      style='--radio-dot-svg: url(&apos;data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(233,41,50)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3ccircle cx=%278%27 cy=%278%27 r=%273%27/%3e%3c/svg%3e&apos;); font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'
    >
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f3e7e8] px-10 py-3">
          <div class="flex items-center gap-4 text-[#1b0e0e]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_6_330)">
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M24 0.757355L47.2426 24L24 47.2426L0.757355 24L24 0.757355ZM21 35.7574V12.2426L9.24264 24L21 35.7574Z"
                    fill="currentColor"
                  ></path>
                </g>
                <defs>
                  <clipPath id="clip0_6_330"><rect width="48" height="48" fill="white"></rect></clipPath>
                </defs>
              </svg>
            </div>
            <h2 class="text-[#1b0e0e] text-lg font-bold leading-tight tracking-[-0.015em]">FlavorPlate</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8">
            <div class="flex items-center gap-9">
              <a class="text-[#1b0e0e] text-sm font-medium leading-normal" href="{{ url_for('index') }}">Home</a>
              <a class="text-[#1b0e0e] text-sm font-medium leading-normal" href="#">Menu</a> <!-- Link to menu page -->
              <a class="text-[#1b0e0e] text-sm font-medium leading-normal" href="#">Catering</a> <!-- Placeholder -->
               {% if current_user.is_authenticated %}
              <a class="text-[#1b0e0e] text-sm font-medium leading-normal" href="{{ url_for('make_reservation') }}">Make a Reservation</a>
              <a class="text-[#1b0e0e] text-sm font-medium leading-normal" href="{{ url_for('my_reservations') }}">My Reservations</a>
              {% endif %}
              <a class="text-[#1b0e0e] text-sm font-medium leading-normal" href="#">About</a> <!-- Placeholder -->
            </div>
            <!-- Auth Status, Cart, and Profile Icon -->
            <div class="flex items-center gap-2">
                {% if current_user.is_authenticated %}
                    <span class="text-[#1b0e0e] text-sm font-medium">Hi, {{ current_user.username }}</span>
                    <a href="{{ url_for('logout') }}"
                       class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e92932] text-[#fcf8f8] text-sm font-bold leading-normal tracking-[0.015em]">
                        <span class="truncate">Logout</span>
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}"
                       class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e92932] text-[#fcf8f8] text-sm font-bold leading-normal tracking-[0.015em]">
                        <span class="truncate">Sign In</span>
                    </a>
                    <a href="{{ url_for('register') }}"
                       class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e92932] text-[#fcf8f8] text-sm font-bold leading-normal tracking-[0.015em]">
                        <span class="truncate">Register</span>
                    </a>
                {% endif %}
                <button
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#f3e7e8] text-[#1b0e0e] text-sm font-bold leading-normal tracking-[0.015em]"
                >
                  <span class="truncate">Cart (3)</span>
                </button>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('profile') }}"> <!-- Link to profile page -->
                    <div
                      class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
                      style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCAo8IWECcMZLuKcGLuN7czr_BXKKNiUdB6wbElNIAec298ap_fd99R8XdBmh5XTrKmjMrFXyj64_J2w8wuhUoj5-UEqgENBFtGDXGMc43u9M3uAzKOIbtiMgLkDlU93lvdt_jREpmDyBOAgQIZx39j1ZqQRE8MOuXOZDQZ_y9pA3iCotrCbgoe8Ctni5OVfySVcmpAQ0KD-vv5pSC8-1k3DtoiyvskbkzjjoZBGi4dSLlQSQP27JlNC-ak3x_pMMwezNxlK0vY8TU");'
                    ></div>
                </a>
                {% endif %}
            </div>
          </div>
        </header>
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col w-[512px] max-w-[512px] py-5 max-w-[960px] flex-1">
            <div class="flex flex-wrap gap-2 p-4">
              <a class="text-[#994d51] text-base font-medium leading-normal" href="#">Menu</a>
              <span class="text-[#994d51] text-base font-medium leading-normal">/</span>
              <span class="text-[#1b0e0e] text-base font-medium leading-normal">Cart</span>
            </div>
            <h2 class="text-[#1b0e0e] tracking-light text-[28px] font-bold leading-tight px-4 text-left pb-3 pt-5">Your Order</h2>
            
            <!-- Cart items will be rendered here by JavaScript -->
            <div class="overflow-x-auto p-4">
                <table class="min-w-full bg-white shadow-md rounded-lg">
                    <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <tr>
                            <th class="py-3 px-6 text-left">Item</th>
                            <th class="py-3 px-6 text-left">Price</th>
                            <th class="py-3 px-6 text-center">Quantity</th>
                            <th class="py-3 px-6 text-left">Subtotal</th>
                            <th class="py-3 px-6 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light" id="cart-items-container">
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="text-right mt-4 mr-6 pr-4">
                <span class="text-lg font-semibold">Total: </span>
                <span class="text-lg font-semibold" id="cart-total">$0.00</span>
            </div>

            <h3 class="text-[#1b0e0e] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Order Mode</h3>
            <div class="flex flex-col gap-3 p-4">
              <label class="flex items-center gap-4 rounded-xl border border-solid border-[#e7d0d1] p-[15px]">
                <input
                  type="radio"
                  class="h-5 w-5 border-2 border-[#e7d0d1] bg-transparent text-transparent checked:border-[#e92932] checked:bg-[image:--radio-dot-svg] focus:outline-none focus:ring-0 focus:ring-offset-0 checked:focus:border-[#e92932]"
                  name="b723d5e8-343f-43ed-aae6-cc5437447217"
                  checked=""
                />
                <div class="flex grow flex-col"><p class="text-[#1b0e0e] text-sm font-medium leading-normal">Takeaway</p></div>
              </label>
            </div>
            <h3 class="text-[#1b0e0e] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Payment</h3>
            <div class="flex flex-col gap-3 p-4">
              <label class="flex items-center gap-4 rounded-xl border border-solid border-[#e7d0d1] p-[15px]">
                <input
                  type="radio"
                  class="h-5 w-5 border-2 border-[#e7d0d1] bg-transparent text-transparent checked:border-[#e92932] checked:bg-[image:--radio-dot-svg] focus:outline-none focus:ring-0 focus:ring-offset-0 checked:focus:border-[#e92932]"
                  name="672083c9-68c9-4512-844e-2deede43b2f4"
                  checked=""
                />
                <div class="flex grow flex-col"><p class="text-[#1b0e0e] text-sm font-medium leading-normal">Credit Card</p></div>
              </label>
              <label class="flex items-center gap-4 rounded-xl border border-solid border-[#e7d0d1] p-[15px]">
                <input
                  type="radio"
                  class="h-5 w-5 border-2 border-[#e7d0d1] bg-transparent text-transparent checked:border-[#e92932] checked:bg-[image:--radio-dot-svg] focus:outline-none focus:ring-0 focus:ring-offset-0 checked:focus:border-[#e92932]"
                  name="672083c9-68c9-4512-844e-2deede43b2f4"
                />
                <div class="flex grow flex-col"><p class="text-[#1b0e0e] text-sm font-medium leading-normal">Cash on Delivery</p></div>
              </label>
            </div>
            <p class="text-[#994d51] text-sm font-normal leading-normal pb-3 pt-1 px-4">By placing your order, you agree to our terms and conditions.</p>
            <div class="flex px-4 py-3">
              <button id="confirm-order-btn"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 flex-1 bg-[#e92932] text-[#fcf8f8] text-sm font-bold leading-normal tracking-[0.015em]"
              >
                <span class="truncate">Confirm Order</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <script src="{{ url_for('static', filename='js/cart.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        updateCartDisplay(); // Update header cart count
        renderCartItemsOnPage(); // Populate the cart items on this page

        const confirmOrderButton = document.getElementById('confirm-order-btn');
        if (confirmOrderButton) {
            confirmOrderButton.addEventListener('click', () => {
                const cart = getCart();
                if (cart.length === 0) {
                    alert('Your cart is empty. Please add items before confirming.');
                    return;
                }
                console.log('Confirming order with cart:', cart);
                // For Phase 2:
                // if (!current_user.is_authenticated) { // This check needs to be done server-side or via a global JS var
                //     window.location.href = "{{ url_for('login', next=url_for('your_order_page_name_here')) }}"; // Replace 'your_order_page_name_here'
                //     return;
                // }

                fetch("{{ url_for('submit_order') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Include CSRF token if/when implemented
                    },
                    body: JSON.stringify(cart)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.order_id) {
                        alert(data.message || 'Order placed successfully!');
                        clearCart(); // Clear cart from localStorage
                        window.location.href = `/order_confirmed/${data.order_id}`; // Redirect to order confirmation page
                    } else {
                        alert(`Error placing order: ${data.message || 'Unknown error'}`);
                    }
                })
                .catch(error => {
                    console.error('Error submitting order:', error);
                    alert('There was an error submitting your order. Please try again.');
                });
            });
        }
    });

    function renderCartItemsOnPage() {
        const cart = getCart();
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalElement = document.getElementById('cart-total');
        
        if (!cartItemsContainer || !cartTotalElement) {
            console.error('Cart container or total element not found on Your_order.html');
            return;
        }

        cartItemsContainer.innerHTML = ''; // Clear existing items

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<tr><td colspan="5" class="text-center py-4">Your cart is empty. <a href="{{ url_for("index") }}" class="text-indigo-600 hover:text-indigo-500">Continue Shopping</a></td></tr>';
            cartTotalElement.textContent = '$0.00';
            return;
        }

        cart.forEach(item => {
            const row = document.createElement('tr');
            row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');

            let itemNameHTML = escapeHTML(item.name);
            if (item.customizations && typeof item.customizations === 'object' && Object.keys(item.customizations).length > 0) {
                itemNameHTML += '<br/><small class="text-xs text-gray-500">';
                if (item.customizations.bread) itemNameHTML += `Bread: ${escapeHTML(item.customizations.bread)}, `;
                if (item.customizations.sauce) itemNameHTML += `Sauce: ${escapeHTML(item.customizations.sauce)}, `;
                if (item.customizations.addons && item.customizations.addons.length > 0) {
                    itemNameHTML += `Add-ons: ${item.customizations.addons.map(escapeHTML).join(', ')}`;
                }
                itemNameHTML = itemNameHTML.replace(/, $/, ''); 
                itemNameHTML += '</small>';
            } else if (typeof item.customizations === 'string' && item.customizations) {
                itemNameHTML += `<br/><small class="text-xs text-gray-500">${escapeHTML(item.customizations)}</small>`;
            }
            
            row.innerHTML = `
                <td class="py-3 px-6 text-left whitespace-nowrap">${itemNameHTML}</td>
                <td class="py-3 px-6 text-left">$${parseFloat(item.price).toFixed(2)}</td>
                <td class="py-3 px-6 text-center">
                    <input type="number" value="${item.quantity}" min="1" class="w-16 text-center border border-gray-300 rounded quantity-input" 
                           data-item-id="${escapeHTML(item.menuItemId)}" 
                           data-customizations='${JSON.stringify(item.customizations)}'>
                </td>
                <td class="py-3 px-6 text-left">$${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                <td class="py-3 px-6 text-center">
                    <button class="text-red-500 hover:text-red-700 font-medium remove-item-btn"
                            data-item-id="${escapeHTML(item.menuItemId)}"
                            data-customizations='${JSON.stringify(item.customizations)}'>
                        Remove
                    </button>
                </td>
            `;
            cartItemsContainer.appendChild(row);
        });

        cartTotalElement.textContent = `$${getCartTotal().toFixed(2)}`;

        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', (event) => {
                const itemId = event.target.dataset.itemId;
                const customizations = JSON.parse(event.target.dataset.customizations);
                const newQuantity = parseInt(event.target.value);
                if (!isNaN(newQuantity) && newQuantity > 0) {
                    updateQuantity(itemId, newQuantity, customizations);
                } else { // If quantity is invalid or zero, remove item
                    removeFromCart(itemId, customizations);
                }
            });
        });

        document.querySelectorAll('.remove-item-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const itemId = event.target.dataset.itemId;
                const customizations = JSON.parse(event.target.dataset.customizations);
                removeFromCart(itemId, customizations);
            });
        });
    }

    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/[&<>"']/g, function (match) {
            return {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[match];
        });
    }
  </script>
</html>
